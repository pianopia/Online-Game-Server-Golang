# WebSocket Game Server API 仕様書

このドキュメントでは、WebSocketゲームサーバーとクライアント間の通信メッセージ仕様について説明します。

## 概要

- **プロトコル**: WebSocket
- **エンドポイント**: `ws://127.0.0.1:8080`
- **メッセージ形式**: JSON
- **文字エンコーディング**: UTF-8

## データ型

### Player オブジェクト

```json
{
  "id": "UUID文字列",
  "name": "プレイヤー名",
  "x": 0.0,
  "y": 0.0,
  "health": 100.0,
  "score": 0
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `id` | String (UUID) | プレイヤーの一意識別子 |
| `name` | String | プレイヤー名 (例: "Player_4a44c898") |
| `x` | Number (f32) | X座標 |
| `y` | Number (f32) | Y座標 |
| `health` | Number (f32) | 体力 (初期値: 100.0) |
| `score` | Number (u32) | スコア (初期値: 0) |

---

## サーバーからクライアントへのメッセージ

### 1. PlayerJoin - プレイヤー参加通知

プレイヤーが新しくゲームに参加した際に送信されます。

```json
{
  "PlayerJoin": {
    "player_id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "Player_4a44c898"
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `player_id` | String (UUID) | 参加したプレイヤーのID |
| `name` | String | プレイヤー名 |

**送信タイミング**: 
- 新しいプレイヤーが接続した時
- 接続したプレイヤー自身にも送信される

---

### 2. PlayerLeave - プレイヤー退出通知

プレイヤーがゲームから退出した際に送信されます。

```json
{
  "PlayerLeave": {
    "player_id": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `player_id` | String (UUID) | 退出したプレイヤーのID |

**送信タイミング**: プレイヤーがWebSocket接続を切断した時

---

### 3. PlayerMove - プレイヤー移動通知

プレイヤーが移動した際に送信されます。

```json
{
  "PlayerMove": {
    "player_id": "550e8400-e29b-41d4-a716-446655440000",
    "x": 100.0,
    "y": 50.0
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `player_id` | String (UUID) | 移動したプレイヤーのID |
| `x` | Number (f32) | 新しいX座標 |
| `y` | Number (f32) | 新しいY座標 |

**送信タイミング**: プレイヤーから移動メッセージを受信した時（移動したプレイヤー以外に送信）

---

### 4. GameState - ゲーム状態更新

現在のゲーム状態をクライアントに送信します。

```json
{
  "GameState": {
    "players": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "Player_4a44c898",
        "x": 100.0,
        "y": 50.0,
        "health": 100.0,
        "score": 10
      }
    ],
    "timestamp": 1692800400
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `players` | Array[Player] | 現在接続中の全プレイヤー情報 |
| `timestamp` | Number (u64) | UNIXタイムスタンプ (秒) |

**送信タイミング**: 
- プレイヤーが新しく参加した時（そのプレイヤーに送信）
- プレイヤーが移動した時（全プレイヤーに送信）

---

### 5. Chat - チャットメッセージ

チャットメッセージを送信します。

```json
{
  "Chat": {
    "player_id": "550e8400-e29b-41d4-a716-446655440000",
    "message": "Hello, world!"
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `player_id` | String (UUID) | メッセージを送信したプレイヤーのID |
| `message` | String | チャットメッセージ内容 |

**送信タイミング**: プレイヤーからチャットメッセージを受信した時（全プレイヤーに送信）

---

### 6. Error - エラーメッセージ

エラーが発生した際に送信されます。

```json
{
  "Error": {
    "message": "Invalid message format"
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `message` | String | エラーメッセージ |

**送信タイミング**: サーバー側でエラーが発生した時

---

## クライアントからサーバーへのメッセージ

### 1. PlayerMove - プレイヤー移動要求

プレイヤーの移動を要求します。

```json
{
  "PlayerMove": {
    "player_id": "550e8400-e29b-41d4-a716-446655440000",
    "x": 110.0,
    "y": 60.0
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `player_id` | String (UUID) | 移動するプレイヤーのID（接続中のプレイヤーIDと一致する必要がある） |
| `x` | Number (f32) | 移動先のX座標 |
| `y` | Number (f32) | 移動先のY座標 |

**制限事項**:
- X座標の範囲: 0.0 ～ 580.0 (画面幅 600px - プレイヤー幅 20px)
- Y座標の範囲: 0.0 ～ 380.0 (画面高さ 400px - プレイヤー高さ 20px)

---

### 2. PlayerAction - プレイヤーアクション

プレイヤーのアクション（攻撃、アイテム取得など）を実行します。

```json
{
  "PlayerAction": {
    "player_id": "550e8400-e29b-41d4-a716-446655440000",
    "action": "attack",
    "data": {}
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `player_id` | String (UUID) | アクションを実行するプレイヤーのID |
| `action` | String | アクションタイプ（"attack", "pickup"） |
| `data` | Object | アクション固有のデータ |

**利用可能なアクション**:
- `"attack"`: 攻撃を実行
- `"pickup"`: アイテムを取得（スコア +10）

---

### 3. Chat - チャットメッセージ送信

チャットメッセージを送信します。

```json
{
  "Chat": {
    "player_id": "550e8400-e29b-41d4-a716-446655440000",
    "message": "Hello everyone!"
  }
}
```

| フィールド | 型 | 説明 |
|-----------|---|------|
| `player_id` | String (UUID) | メッセージを送信するプレイヤーのID |
| `message` | String | チャットメッセージ内容 |

---

## 接続フロー

1. **接続**: クライアントがWebSocketでサーバーに接続
2. **自動参加**: サーバーが自動的にプレイヤーIDと名前を生成
3. **PlayerJoin通知**: サーバーから全クライアント（自分含む）にPlayerJoinメッセージを送信
4. **GameState送信**: サーバーから新しいクライアントに現在のゲーム状態を送信
5. **ゲームプレイ**: クライアントがPlayerMove、PlayerAction、Chatメッセージを送信
6. **切断**: WebSocket接続が切断されると自動的にPlayerLeaveメッセージが送信される

---

## エラーハンドリング

- **無効なメッセージ形式**: JSON解析エラーの場合、サーバーログに警告が出力される
- **権限チェック**: player_idが接続中のクライアントIDと一致しない場合、メッセージは無視される
- **接続エラー**: WebSocketエラーが発生した場合、自動的にクライアントが切断される

---

## 技術仕様

- **WebSocketライブラリ**: tokio-tungstenite
- **シリアライゼーション**: serde_json
- **非同期処理**: Tokio
- **プレイヤーID**: UUID v4
- **同期**: Arc + RwLock でマルチスレッド対応